<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ðŸŒŠ Memory Pond â€” Archive Viewer</title>
<style>
  :root{
    --ink:#1b1f23; --muted:#66707a; --bg:#f7fbff; --card:#ffffff; --ring:#d7e9ff;
    --l0:#EAF6FF; --l1:#E6F5F0; --l2:#EEF0FF;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;background:linear-gradient(#f7fbff,rgba(247,251,255,.6));backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid #e8eef7; padding:12px 16px; z-index:10}
  h1{margin:0;font-size:20px}
  .nav{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .btn{background:#fff;border:1px solid #ced9e6;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{border-color:#98b6d9}
  input[type="text"]{border:1px solid #ced9e6;border-radius:10px;padding:8px 10px;min-width:240px}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #cbd5e1;color:#475569;background:#fff}
  .grid{max-width:1000px;margin:20px auto;padding:0 12px;display:grid;gap:14px}
  .card{background:var(--card); border:1px solid #ecf0f6; border-radius:16px; box-shadow:0 2px 10px rgba(16,24,40,.06)}
  .card .hd{padding:14px 16px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .title{font-weight:650}
  .meta{color:var(--muted);font-size:13px}
  .body{padding:12px 16px 16px}
  .levels{display:grid;gap:10px}
  .lvl{border-radius:12px;padding:10px 12px;border:1px solid #e6ebf3}
  .lvl[data-level="Descriptive"]{background:var(--l0)}
  .lvl[data-level="Analytic"]{background:var(--l1)}
  .lvl[data-level="Reflexive"]{background:var(--l2)}
  details{margin-top:8px}
  summary{cursor:pointer;color:#334155}
  .artifact{margin-top:10px;border-radius:12px;border:1px dashed #c0ccdd;padding:10px 12px;background:#fafcff}
  .empty{opacity:.7;text-align:center;margin:64px 0}
  .drop{border:2px dashed #b6c7de;border-radius:14px;padding:18px 14px;text-align:center;color:#475569;background:#f8fbff}
  .counter{font-size:13px;color:#64748b}
  .pill{border-radius:999px;padding:0 8px;border:1px solid #cbd5e1;margin-left:6px;font-size:12px}
  .hidden{display:none}
  .footer{max-width:1000px;margin:30px auto 40px; padding:0 12px; color:#7a8696; font-size:13px}
  @media print{header,.footer{display:none} .grid{margin:0} body{background:#fff}}
</style>
</head>
<body>

<header>
  <h1>ðŸŒŠ Memory Pond â€” Archive Viewer</h1>
  <div class="nav">
    <label class="btn" for="file">ðŸ“‚ Open .jsonl</label>
    <input id="file" type="file" accept=".jsonl,.txt,application/json" class="hidden" />
    <button id="demo" class="btn">ðŸ§ª Load sample line</button>
    <input id="q" type="text" placeholder="Search title / offering / summariesâ€¦" />
    <span id="count" class="counter">0 memories</span>
    <span class="pill">Tip: you can also drag & drop your <b>memories.jsonl</b> here</span>
  </div>
</header>

<div class="grid" id="grid">
  <div class="drop" id="drop">Drop <b>memories.jsonl</b> to render your archive here.</div>
</div>

<div class="footer">
  Rendered locally. Your data never leaves your browser. Supports JSON Lines: one memory JSON per line.
</div>

<script>
const fileInput = document.getElementById('file');
const grid = document.getElementById('grid');
const q = document.getElementById('q');
const count = document.getElementById('count');
const drop = document.getElementById('drop');

let MEMS = [];
let FILTERED = [];

function safe(text){ return (text||"").toString(); }
function esc(text){ return safe(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function parseJSONL(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out = [];
  for(const line of lines){
    try{ out.push(JSON.parse(line)); }catch(e){ console.warn('Bad JSONL line, skipped:', line); }
  }
  return out;
}

function summaryBlock(s){
  const lvl = esc(s.level || '');
  const summary = esc((s.summary||'').trim());
  return `<div class="lvl" data-level="${lvl}">
    <div class="meta"><b>${lvl}</b></div>
    <div>${summary || '<em>No summary</em>'}</div>
  </div>`;
}

function card(mem, idx){
  const t = esc(mem.title);
  const ts = esc(mem.timestamp);
  const off = esc(mem.offering);
  const choice = esc(mem.archive_choice || 'â€”');
  const levels = Array.isArray(mem.summaries) ? mem.summaries.map(summaryBlock).join('') : '';
  // artifact is trusted local content generated by your own app â€” render as HTML:
  const artifactHTML = (mem.artifact || '').toString();

  return `<article class="card" data-idx="${idx}">
    <div class="hd">
      <div class="title">${t || 'Untitled'}</div>
      <span class="tag">Choice: <b>${choice}</b></span>
      <div class="meta">Â· ${ts || ''}</div>
    </div>
    <div class="body">
      <div><span class="meta">Offering:</span> ${off || '<em>â€”</em>'}</div>
      <div class="levels" style="margin-top:10px">${levels}</div>
      ${artifactHTML ? `<details open><summary>ðŸª¶ Artifact</summary><div class="artifact">${artifactHTML}</div></details>` : ''}
    </div>
  </article>`;
}

function render(list){
  FILTERED = list;
  if(!list.length){
    grid.innerHTML = `<div class="empty">No memories match your search.</div>`;
    count.textContent = `0 memories`;
    return;
  }
  grid.innerHTML = list.map(card).join('');
  count.textContent = `${list.length} ${list.length===1?'memory':'memories'}`;
}

function loadText(text){
  MEMS = parseJSONL(text);
  // Sort newest first
  MEMS.sort((a,b)=> (b.timestamp||'').localeCompare(a.timestamp||''));
  applyFilter();
}

function applyFilter(){
  const term = q.value.trim().toLowerCase();
  if(!term){ render(MEMS); return; }
  const norm = s => (s||'').toString().toLowerCase();
  const pick = m => {
    if(norm(m.title).includes(term)) return true;
    if(norm(m.offering).includes(term)) return true;
    if(norm(m.archive_choice).includes(term)) return true;
    if(Array.isArray(m.summaries)){
      for(const s of m.summaries){
        if(norm(s.level).includes(term) || norm(s.summary).includes(term)) return true;
      }
    }
    return false;
  };
  render(MEMS.filter(pick));
}

// Events
fileInput.addEventListener('change', async e=>{
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  drop.style.display='none';
  loadText(text);
});
q.addEventListener('input', applyFilter);

// Drag & drop
['dragenter','dragover'].forEach(ev=>{
  document.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor='#6aa2e8'; });
});
['dragleave','drop'].forEach(ev=>{
  document.addEventListener(ev, e=>{ e.preventDefault(); drop.style.borderColor='#b6c7de'; });
});
document.addEventListener('drop', async e=>{
  const file = e.dataTransfer.files && e.dataTransfer.files[0];
  if(!file) return;
  const text = await file.text();
  drop.style.display='none';
  loadText(text);
});

// Demo button loads a single example line (safe to remove)
document.getElementById('demo').addEventListener('click', ()=>{
  const sample = `{"timestamp":"2025-10-27T23:30:37","title":"Pebble","offering":"Had a tense chat with a friend.","summaries":[{"level":"Descriptive","summary":"You recalled the moment with its tight edges and careful care."},{"level":"Analytic","summary":"It mattered because you avoid conflict until it erupts."},{"level":"Reflexive","summary":"You value honesty and gentleness together; thatâ€™s the path youâ€™re choosing."}],"archive_choice":"float","artifact":"<div class='pond-card pond-l2'><div class='pond-title'>ðŸª¶ Memory Artifact</div><div class='pond-body'>You recognized the paradoxâ€”honesty with softnessâ€”and decided to carry it lightly.<br><br><b>You chose to let it float: accepted and held lightly.</b></div></div>"}`;
  drop.style.display='none';
  loadText(sample+"\n");
});
</script>
</body>
</html>
